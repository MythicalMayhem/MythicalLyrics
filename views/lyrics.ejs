<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%=' '+title%> - <%=' '+author%>
    </title>
    <link rel="stylesheet" href="lyrics.css">
</head>

<body>
    <nav id="nav">
        <a href="/">home</a>
        <a href="/about">About</a>
        <a href="/privacy">Privacy</a>
    </nav>

    <div id="body">
        <div id="lyricsContainer" class="container">
            <div class="container-inner">
                <%pagelyrics.forEach(bar=> {bar = bar.toString();
                    if (bar == '') { ;%>
                    <br>
                    <% }else{ %>
                        <% if (bar[0]=='[' ){ %>

            <p id='bar'>
                <span class="marker">
                    <%=bar %>
                </span>
            </p><br>
            <%}else{%>
                <p id="bar">
                    <%= bar %>
                </p>
                <%}%>

                    <%}}) %>

                        </div>
                        <div class="scroll-marker"></div>
                        </div>

                        <div id="wrapper">
                            <center><button onclick="downloadimage()" id="downloader">DOWNLOAD</button></center>
                            <div id="mainContainer">
                                <div id="identity">
                                    <img src="<%=art%>" crossorigin="anonymous" alt="">
                                    <div id="name">
                                        <p>
                                            <%=title%>
                                        </p>
                                        <p>
                                            <%=author%>
                                        </p>
                                    </div>
                                </div>
                                <div id="barz">
                                    <br>
                                    <h3 contenteditable="true" id="bar">choose or type lyrics</h3>
                                    <br>

                                </div>
                                <div id="other">
                                    <img id="spotify_logo" style="height: 32px;"
                                        src="svg/Spotify_Logo_RGB_White.png"
                                        alt="spotify icon" crossorigin="anonymous" />
                                </div>
                            </div>
                        </div>
                        </div>
                        <footer>
                            <p>Made By <a href="https://github.com/MythicalMayhem/sgxlyrics">MythicalMayhem</a></p>
                            <p>Made Possible By
                                <a href="https://www.genius.com" target="_blank">Genius.com</a> and
                                <a href="https://www.spotify.com" target="_blank">spotify.com</a> api
                            </p>
                        </footer>
                        <script src="https://html2canvas.hertzen.com/dist/html2canvas.js">

                        </script>
                        <script>
                            function downloadimage() {
                                var container = document.getElementById("mainContainer");
                                html2canvas(container, {
                                    allowTaint: true, useCORS: true, backgroundColor: null , imageTimeout: 15000
                                }).then(function (canvas) {
                                    container.style.boxShadow = 'none'
                                    var link = document.createElement("a");
                                    document.body.appendChild(link);
                                    link.download = "html_image.png";
                                    link.href = canvas.toDataURL();
                                    link.target = '_blank';
                                    link.click();
                                    container.style.boxShadow = '0px 0px 20px rgba(0, 0, 0, 0.747)'
                                });
                            }
                            function changeBackground(nodes, items) {
                                for (let j = 0; j < nodes.length; j++) {
                                    if (items.indexOf(j) == -1) {
                                        nodes[j].style.backgroundColor = '#179b45'
                                        nodes[j].style.color = 'black'
                                        nodes[j].style.borderInline = 'none'
                                    } else {
                                        nodes[j].style.backgroundColor = 'black'
                                        nodes[j].style.borderInline = '5px solid black'
                                        nodes[j].style.color = 'white'
                                    }
                                }
                                if (selected.length >= 5) { return }
                                if (items[0] > 0) {
                                    nodes[items[0] - 1].style.backgroundColor = 'lightgray'
                                    nodes[items[0] - 1].style.borderInline = '5px solid lightgray'
                                }
                                if (items[items.length - 1] < nodes.length - 1) {
                                    nodes[items[items.length - 1] + 1].style.backgroundColor = 'lightgray'
                                    nodes[items[items.length - 1] + 1].style.borderInline = '5px solid lightgray'
                                }
                            }
  
                            function resize() {
                                var container = document.querySelector('.container');
                                var containerInner = document.querySelector('.container-inner');

                                var containerHeight = container.offsetHeight;
                                var containerScrollHeight = containerInner.scrollHeight;

                                var scrollMarker = document.querySelector('.scroll-marker');

                                var colorfulStuff = document.querySelectorAll('.container-inner span'); // colorful spans from text



                                colorfulStuff.forEach(function (span) { // loop to create each marker

                                    var spanTop = span.offsetTop;
                                    var spanBottom = spanTop + span.offsetHeight;

                                    var markerTop = Math.ceil(spanTop * containerHeight / containerScrollHeight);
                                    var markerBottom = Math.ceil(spanBottom * containerHeight / containerScrollHeight);
                                    if (span.className === "marker") { var markerColor = 'black'; }
                                    var markerElement = document.createElement("span"); // create the marker, set color and position and put it there
                                    markerElement.style.backgroundColor = markerColor;
                                    markerElement.style.top = markerTop + "px"
                                    markerElement.style.height = (markerBottom - markerTop + 2) + "px"
                                    scrollMarker.appendChild(markerElement);

                                })
                            }
                            resize()
                            addEventListener("resize", (event) => { resize() });




                            var kids = document.getElementById('lyricsContainer').querySelectorAll('#bar')

                            var selected = []
                            for (let i = 0; i < kids.length; i++) {
                                const el = kids[i];

                                el.addEventListener('click', (e) => {
                                    if (selected.length == 0) { selected = [i] }
                                    else if (selected.indexOf(i) != -1) {
                                        if (selected[0] == i) { selected.shift() }
                                        else if (selected[selected.length - 1] == i) { selected.pop() }
                                        else { selected = [] }
                                    } else if (selected.length < 5) { if (i - selected[selected.length - 1] == 1) { selected.push(i) } else if (selected[0] - i == 1) { selected.unshift(i) } else { selected = [i] } }
                                    else { selected = [i] }
                                    while (document.getElementById('barz').hasChildNodes()) {
                                        document.getElementById('barz').removeChild(document.getElementById('barz').firstChild)
                                    }
                                    selected.forEach(el => {
                                        const text = kids[el].textContent
                                        var clone = kids[el].cloneNode(false)
                                        clone.textContent = text
                                        clone.className = ''
                                        clone.style.backgroundColor = 'transparent'
                                        clone.style.borderInline = 'none'
                                        clone.style.color = 'white'
                                        clone.style.margin = '5px 0'
                                        document.getElementById('barz').appendChild(clone)
                                        //var breaker = document.createElement('br')
                                        //document.getElementById('barz').appendChild(breaker)
                                    })
                                    if (document.getElementById('barz').hasChildNodes() == false) {
                                        var a = document.createElement('h3')
                                        a.id = 'bar'
                                        a.setAttribute('contenteditable', 'true')
                                        const text = document.createTextNode("choose or type lyrics");
                                        a.appendChild(text)
                                        document.getElementById('barz').appendChild(a)
                                    }
                                    changeBackground(kids, selected)
                                })
                            }


                        </script>
                        </body>

</html>